/********************* ROLES **********************/

/********************* UDFS ***********************/

/****************** GENERATORS ********************/

CREATE GENERATOR GEN_COMPRA_PK;
CREATE GENERATOR GEN_INVENTARIO_PK;
CREATE GENERATOR GEN_PEDIDO_PK;
CREATE GENERATOR GEN_VENTA_PK;
/******************** DOMAINS *********************/

/******************* PROCEDURES ******************/

/******************** TABLES **********************/

CREATE TABLE COMPRA
(
  CODECOM integer NOT NULL,
  FECHA timestamp NOT NULL,
  CODEPED integer,
  NIT char(14) NOT NULL,
  CONSTRAINT PK_COMPRA PRIMARY KEY (CODECOM)
);
CREATE TABLE INVENTARIO
(
  CODEINV integer NOT NULL,
  FECHA timestamp NOT NULL,
  CONSTRAINT PK_INVENTARIO PRIMARY KEY (CODEINV)
);
CREATE TABLE ITEMCOMPRA
(
  CODECOM integer NOT NULL,
  BARCODE char(20) NOT NULL,
  CANTIDAD smallint NOT NULL,
  CONSTRAINT PK_ITEMCOMPRA PRIMARY KEY (CODECOM,BARCODE)
);
CREATE TABLE ITEMINVENT
(
  CODEINV integer NOT NULL,
  BARCODE char(20) NOT NULL,
  CANTIDAD smallint NOT NULL,
  CONSTRAINT PK_ITEMINVENT PRIMARY KEY (CODEINV,BARCODE)
);
CREATE TABLE ITEMPEDIDO
(
  CODEPED integer NOT NULL,
  BARCODE char(20) NOT NULL,
  CANTIDAD smallint NOT NULL,
  CONSTRAINT PK_ITEMPEDIDO PRIMARY KEY (CODEPED,BARCODE)
);
CREATE TABLE ITEMVENTA
(
  CODEVEN integer NOT NULL,
  BARCODE char(20) NOT NULL,
  CANTIDAD smallint NOT NULL,
  CONSTRAINT PK_ITEMVENTA PRIMARY KEY (CODEVEN,BARCODE)
);
CREATE TABLE PEDIDO
(
  CODEPED integer NOT NULL,
  FECHA timestamp NOT NULL,
  LLEGADA timestamp,
  NIT char(14) NOT NULL,
  CONSTRAINT PK_PEDIDO PRIMARY KEY (CODEPED)
);
CREATE TABLE PRODUCTO
(
  BARCODE char(20) NOT NULL,
  NOMBRE varchar(20) NOT NULL,
  FOTO varchar(10),
  CADUC timestamp,
  NIT char(14) NOT NULL,
  CONSTRAINT PK_PRODUCTO PRIMARY KEY (BARCODE)
);
CREATE TABLE PROVEEDOR
(
  NIT char(14) NOT NULL,
  NOMBRE varchar(15) NOT NULL,
  FOTO varchar(10),
  CONSTRAINT PK_PROVEEDOR PRIMARY KEY (NIT)
);
CREATE TABLE VENTA
(
  CODEVEN integer NOT NULL,
  FECHA timestamp NOT NULL,
  CONSTRAINT PK_VENTA PRIMARY KEY (CODEVEN)
);
/********************* VIEWS **********************/

/******************* EXCEPTIONS *******************/

/******************** TRIGGERS ********************/

SET TERM ^ ;
CREATE TRIGGER BI_COMPRA_ID FOR COMPRA ACTIVE
BEFORE INSERT POSITION 0
AS
BEGIN
    IF ((new.CODECOM IS NULL) or (new.CODECOM = 0))  THEN
      new.CODECOM = GEN_ID(gen_COMPRA_pk, 1);
END^
SET TERM ; ^
SET TERM ^ ;
CREATE TRIGGER BI_INVENTARIO_ID FOR INVENTARIO ACTIVE
BEFORE INSERT POSITION 0
AS
BEGIN
    IF ((new.CODEINV IS NULL) or (new.CODEINV = 0))  THEN
      new.CODEINV = GEN_ID(gen_inventario_pk, 1);
END^
SET TERM ; ^
SET TERM ^ ;
CREATE TRIGGER BI_PEDIDO_ID FOR PEDIDO ACTIVE
BEFORE INSERT POSITION 0
AS
BEGIN
    IF ((new.CODEPED IS NULL) or (new.CODEPED = 0))  THEN
      new.CODEPED = GEN_ID(gen_PEDIDO_pk, 1);
END^
SET TERM ; ^
SET TERM ^ ;
CREATE TRIGGER BI_VENTA_ID FOR VENTA ACTIVE
BEFORE INSERT POSITION 0
AS
BEGIN
    IF ((new.CODEVEN IS NULL) or (new.CODEVEN = 0))  THEN
      new.CODEVEN = GEN_ID(gen_VENTA_pk, 1);
END^
SET TERM ; ^

ALTER TABLE COMPRA ADD CONSTRAINT FK_COMPRA_A_PROVEEDOR
  FOREIGN KEY (NIT) REFERENCES PROVEEDOR (NIT);
ALTER TABLE COMPRA ADD CONSTRAINT FK_COMPRA_ENBASE_PEDIDO
  FOREIGN KEY (CODEPED) REFERENCES PEDIDO (CODEPED);
ALTER TABLE ITEMCOMPRA ADD CONSTRAINT FK_COMPRA_FACTURA_PRODUCTO
  FOREIGN KEY (BARCODE) REFERENCES PRODUCTO (BARCODE);
ALTER TABLE ITEMCOMPRA ADD CONSTRAINT FK_PRODUCTO_COMPRADO_COMPRA
  FOREIGN KEY (CODECOM) REFERENCES COMPRA (CODECOM);
ALTER TABLE ITEMINVENT ADD CONSTRAINT FK_INVENTARIO_ALMACENA_PRODUCTO
  FOREIGN KEY (BARCODE) REFERENCES PRODUCTO (BARCODE);
ALTER TABLE ITEMINVENT ADD CONSTRAINT FK_PRODUCTOALMACENADOINVENTARIO
  FOREIGN KEY (CODEINV) REFERENCES INVENTARIO (CODEINV);
ALTER TABLE ITEMPEDIDO ADD CONSTRAINT FK_PEDIDO_REGISTRA_PRODUCTO
  FOREIGN KEY (BARCODE) REFERENCES PRODUCTO (BARCODE);
ALTER TABLE ITEMPEDIDO ADD CONSTRAINT FK_PRODUCTO_SOLICITADO_PEDIDO
  FOREIGN KEY (CODEPED) REFERENCES PEDIDO (CODEPED);
ALTER TABLE ITEMVENTA ADD CONSTRAINT FK_PRODUCTO_VENDIDO_VENTA
  FOREIGN KEY (CODEVEN) REFERENCES VENTA (CODEVEN);
ALTER TABLE ITEMVENTA ADD CONSTRAINT FK_VENTA_FACTURA_PRODUCTO
  FOREIGN KEY (BARCODE) REFERENCES PRODUCTO (BARCODE);
ALTER TABLE PEDIDO ADD CONSTRAINT FK_PROVEEDOR_GESTIONA_PEDIDO
  FOREIGN KEY (NIT) REFERENCES PROVEEDOR (NIT);
ALTER TABLE PRODUCTO ADD CONSTRAINT FK_PROVEEDOR_OFRECE_PRODUCTO
  FOREIGN KEY (NIT) REFERENCES PROVEEDOR (NIT);
GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON COMPRA TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON INVENTARIO TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON ITEMCOMPRA TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON ITEMINVENT TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON ITEMPEDIDO TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON ITEMVENTA TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON PEDIDO TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON PRODUCTO TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON PROVEEDOR TO  AIRSUITE WITH GRANT OPTION;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE
 ON VENTA TO  AIRSUITE WITH GRANT OPTION;


